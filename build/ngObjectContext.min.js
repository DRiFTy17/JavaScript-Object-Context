angular.module("ngObjectContext",[]).provider("objectContext",function(){var k=!0,d=null;this.allowMultipleInstances=function(d){k=!d};this.$get=["$rootScope",function(h){var f=[];return{create:function(l){l="undefined"!==typeof l?!!l:!0;if(k)d||(d=new ObjectContext,l&&f.push({contextInstance:d,deregisterWatchFn:h.$watch(function(){d.evaluate()})}));else{var g=new ObjectContext;l&&f.push({contextInstance:g,deregisterWatchFn:h.$watch(function(){d.evaluate()})});return g}return d},getInstance:function(l){return d||
this.create("undefined"!==typeof l?!!l:!0)},stopAutoWatch:function(d){for(var g=f.length-1;0<=g;g--)f[g].contextInstance===d&&f[g].deregisterWatchFn&&(f[g].deregisterWatchFn(),f.splice(g,1))},startAutoWatch:function(d){if(!d)throw Error("Invalid context instance specified.");for(var g=!1,k=0;k<f.length;k++)f[k].contextInstance===d&&(g=!0);!g&&d.evaluate&&f.push({contextInstance:d,deregisterWatchFn:h.$watch(function(){d.evaluate()})})}}}]});"use strict";
ObjectContext.ObjectStatus={New:"New",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};
function ObjectContext(){var k=this,d=[],h=[],f=function(){for(var a=arguments[0],c=0;c<arguments.length-1;c++)a=a.replace(new RegExp("\\{"+c+"\\}","gm"),arguments[c+1]);return a},l=function(a){if(!(a&&a.changeset&&a.current&&a.current._objectMeta&&a.current._objectMeta.status))throw Error("Invalid object provided");return 0<a.changeset.length||a.current._objectMeta.status===ObjectContext.ObjectStatus.New||a.current._objectMeta.status===ObjectContext.ObjectStatus.Modified||a.current._objectMeta.status===
ObjectContext.ObjectStatus.Deleted},g=function(a,c,b){return{current:a,original:JSON.parse(JSON.stringify(a)),hasChanges:function(){var a=l(this);this.hasChildChanges=!1;for(var b=0;b<d.length;b++){var c=d[b];if(c!==this&&(c.rootParent===this.current||c.parent===this.current)&&l(c)){this.hasChildChanges=!0;break}}return a},changeset:[],rootParent:c,parent:b,hasChildChanges:!1}},s=function(a,c){return a.hasOwnProperty(c)&&"function"!==typeof a[c]&&"_"!==c.toString().substring(0,1)&&"$"!==c.toString().substring(0,
1)?!0:!1},t=function(a,c,b){if(!(a instanceof Array))throw Error("An array must be specified.");for(var d=0;d<a.length;d++)if("function"!==typeof a[d])if(a[d]instanceof Array)t(a[d],c,b);else if("object"===typeof a[d])k.doesObjectExist(a[d])||p(a[d],c,a,b);else throw Error(f('Invalid array item type found ("{0}") at index {1}.',typeof a[d],d));},u=function(a,c,b){for(var d in a)s(a,d)&&(a[d]instanceof Array?t(a[d],c||a,b):"object"!==typeof a[d]||k.doesObjectExist(a[d])||p(a[d],c||a,a,b))},v=function(a,
c){for(var b=null,d=0;d<a.changeset.length;d++)if(a.changeset[d].propertyName===c.toString()){b=a.changeset[d];break}null!==b?b.currentValue=a.current[c]:(a.changeset.push({propertyName:c.toString(),originalValue:a.original[c],currentValue:a.current[c],object:a.current}),a.current._objectMeta.status===ObjectContext.ObjectStatus.Unmodified&&(a.current._objectMeta.status=ObjectContext.ObjectStatus.Modified))},m=function(a){for(var c=0;c<d.length;c++)if(d[c].current===a)return c;return null},q=function(a){a=
m(a);if(null===a)throw Error(f("Invalid object index: {0}",a));return d[a]},r=function(a){if(!a)throw Error("Invalid object provided.");for(var c=0;c<a.changeset.length;c++){var b=a.changeset[c].propertyName;if(a.current[b]instanceof Array)for(var e=a.current[b].length-1;0<=e;e--)a.current[b][e]._objectMeta.status===ObjectContext.ObjectStatus.New&&a.current[b].splice(e,1);else a.current[b]=a.original[b]}a.current._objectMeta.status=a.original._objectMeta.status;a.changeset=[];a.hasChildChanges=!1;
if(!a.rootParent)for(c=d.length-1;0<=c;c--)b=d[c],b!==a&&b.current._objectMeta.status!==ObjectContext.ObjectStatus.New&&(b.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted?b.current._objectMeta.status=b.original._objectMeta.status:b.rootParent===a.current&&r(b))},n=function(a,c){for(var b=[],e=0;e<d.length;e++){var f=d[e];f.current._objectMeta.status!==a||c&&(!0!==c||f.rootParent)||b.push(d[e].current)}return b},p=function(a,c,b,e){if("object"!==typeof a||a instanceof Array)throw Error('Invalid object specified. The value provided must be of type "object".');
if(k.doesObjectExist(a))throw Error("Object already exists in the context.");a._objectMeta?a._objectMeta.status?a._objectMeta.type?a._objectMeta&&a._objectMeta.status&&a._objectMeta.status===ObjectContext.ObjectStatus.New&&(e=!0):a._objectMeta.type="Object":a._objectMeta.status=ObjectContext.ObjectStatus.Unmodified:a._objectMeta={status:e?ObjectContext.ObjectStatus.New:ObjectContext.ObjectStatus.Unmodified,type:"Object"};if(a._objectMeta.status!==ObjectContext.ObjectStatus.New&&a._objectMeta.status!==
ObjectContext.ObjectStatus.Unmodified&&a._objectMeta.status!==ObjectContext.ObjectStatus.Modified&&a._objectMeta.status!==ObjectContext.ObjectStatus.Deleted)throw Error(f("Invalid object status: {0}",a._objectMeta.status));d.push(g(a,c,b));u(a,c,e);return k};this.evaluate=function(){for(var a=0;a<d.length;a++){var c=d[a];if(c.current._objectMeta.status!==ObjectContext.ObjectStatus.Deleted){u(c.current,c.rootParent,!0);var b=void 0;for(b in c.current)if(s(c.current,b))if(c.current[b]instanceof Array){if(!(c.original[b]instanceof
Array))throw Error('Property type ("Array") has been modified from the original type.');c.current[b].length!==c.original[b].length&&v(c,b)}else"object"!==typeof c.current[b]&&c.current[b]!==c.original[b]&&v(c,b)}}for(a=0;a<h.length;a++)(c=h[a])&&"function"===typeof c&&c(this.hasChanges());return this};this.doesObjectExist=function(a){if(!a)return!1;for(var c=0;c<d.length;c++)if(d[c].current===a)return!0;return!1};this.add=function(a,c){return p(a,null,null,c)};this.deleteObject=function(a,c){var b=
m(a);if(null===b)throw Error("Object was not found. Removal failed.");d[b].current._objectMeta.status===ObjectContext.ObjectStatus.New&&(c=!0);!0===c?(d[b].current._objectMeta.status===ObjectContext.ObjectStatus.New&&d[b].parent&&d[b].parent instanceof Array&&d[b].parent.splice(d[b].parent.indexOf(d[b].current),1),d.splice(b,1)):d[b].current._objectMeta.status!==ObjectContext.ObjectStatus.New&&(d[b].current._objectMeta.status=ObjectContext.ObjectStatus.Deleted);for(b=d.length-1;0<=b;b--){var e=d[b];
e.current!==a&&e.rootParent===a&&(!0===c?d.splice(b,1):e.current._objectMeta.status!==ObjectContext.ObjectStatus.New&&(e.current._objectMeta.status=ObjectContext.ObjectStatus.Deleted))}this.evaluate();return this};this.hasChanges=function(a){if(a){a=q(a);if(!a)throw Error("Invalid object provided.");return a.hasChanges()}for(a=0;a<d.length;a++)if(d[a].hasChanges())return!0;return!1};this.hasChildChanges=function(a){if(!a)throw Error("Error determing if object has child changes. The object could not be found.");
a=q(a);if(!a)throw Error("Invalid object provided.");return a.hasChildChanges};this.clear=function(){d=[];h=[];return this};this.getObjects=function(a){for(var c=[],b=0;b<d.length;b++)c.push(a?d[b]:d[b].current);return c};this.getUnmodifiedObjects=function(a){return n(ObjectContext.ObjectStatus.Unmodified,a)};this.getModifiedObjects=function(a){return n(ObjectContext.ObjectStatus.Modified,a)};this.getNewObjects=function(a){return n(ObjectContext.ObjectStatus.New,a)};this.getDeletedObjects=function(a){return n(ObjectContext.ObjectStatus.Deleted,
a)};this.getObjectsByType=function(a){for(var c=[],b=0;b<d.length;b++)d[b].current._objectMeta.type===a&&c.push(d[b].current);return c};this.acceptChanges=function(){for(var a=!1,c=d.length-1;0<=c;c--){var b=d[c];b.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted&&b.parent&&b.parent instanceof Array&&(b.parent.splice(b.parent.indexOf(b.current),1),d.splice(c,1),a=!0)}a&&this.evaluate();for(c=d.length-1;0<=c;c--)b=d[c],b.current._objectMeta.status!==ObjectContext.ObjectStatus.Unmodified&&
(b.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted?d.splice(c,1):(b.changeset=[],b.current._objectMeta.status=ObjectContext.ObjectStatus.Unmodified,b.original=JSON.parse(JSON.stringify(b.current))));this.evaluate();return this};this.getChangeset=function(a,c){var b=null;if(a&&(b=q(a),!b))throw Error("The object could not be found.");var e=b?b.changeset:[];if(!a||c&&!b.rootParent)for(var f=0;f<d.length;f++){var g=d[f];a?g!==b&&g.rootParent===b.current&&0<g.changeset.length&&(e=e.concat(g.changeset)):
e=e.concat(g.changeset)}return e};this.getOriginal=function(a){for(var c=0;c<d.length;c++)if(d[c].current===a)return JSON.parse(JSON.stringify(d[c].original));return null};this.getObjectStatus=function(a){if(!a)throw Error("Invalid object provided.");a=m(a);if(null===a)throw Error(f("Invalid object index: {0}",a));return d[a].current._objectMeta.status};this.rejectChanges=function(a){if(a){a=m(a);if(null===a)throw Error("Could not determine object index. Reject changes failed.");r(d[a])}else for(a=
0;a<d.length;a++)r(d[a]);this.evaluate();return this};this.subscribeChangeListener=function(a){if("function"!==typeof a)throw Error("The provided listener must be a function callback.");h.push(a);return h.length};this.unsubscribeChangeListener=function(a){if(0>h.indexOf(a))throw Error("The provided listener function was not subscribed.");h.splice(h.indexOf(a),1);return h.length};this.log=function(){console.group("ObjectContext");console.log("Has Changes: "+this.hasChanges());console.log("Tracked Objects: "+
d.length);for(var a=[],c=[],b=0;b<d.length;b++)d[b].rootParent?c.push(d[b]):a.push(d[b]);console.group("All Objects");console.dir(d);console.groupEnd("All Objects");console.group("Parent Objects");console.dir(a);console.groupEnd("Parent Objects");console.group("Child Objects");console.dir(c);console.groupEnd("Child Objects");console.group("Objects by Status");console.log("Unmodified",this.getUnmodifiedObjects());console.log("Modified",this.getModifiedObjects());console.log("New",this.getNewObjects());
console.log("Deleted",this.getDeletedObjects());console.groupEnd("Objects by Status");console.groupEnd("ObjectContext");return this}};