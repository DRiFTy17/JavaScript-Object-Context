"use strict";function ObjectContext(){var t=this,e=[],n=[],r=function(t){return JSON.parse(JSON.stringify(t))},o=function(){for(var t=arguments[0],e=0;arguments.length-1>e;e++){var n=RegExp("\\{"+e+"\\}","gm");t=t.replace(n,arguments[e+1])}return t},a=function(t){return t.changeset.length>0||t.getStatus()===ObjectContext.ObjectStatus.New||t.getStatus()===ObjectContext.ObjectStatus.Modified||t.getStatus()===ObjectContext.ObjectStatus.Deleted},s=function(t,n,o){return{current:t,original:r(t),hasChanges:function(){var t=a(this);this.hasChildChanges=!1;for(var n=0;e.length>n;n++){var r=e[n];if(r!==this&&(r.rootParent===this.current||r.parent===this.current)&&a(r)){this.hasChildChanges=!0;break}}return t},changeset:[],rootParent:n,parent:o,hasChildChanges:!1,getStatus:function(){return this.current._objectMeta.status},setStatus:function(t){this.current._objectMeta.status=t},getOriginalStatus:function(){return this.original._objectMeta.status},getType:function(){return this.original._objectMeta.type}}},c=function(t,e){return t.hasOwnProperty(e)&&"function"!=typeof t[e]&&"_"!==(""+e).substring(0,1)&&"$"!==(""+e).substring(0,1)?!0:!1},i=function(e,n,r){if(!(e instanceof Array))throw Error("An array must be specified.");for(var a=0;e.length>a;a++)if("function"!=typeof e[a])if(e[a]instanceof Array)i(e[a],n,r);else{if("object"!=typeof e[a])throw Error(o('Invalid array item type found ("{0}") at index {1}.',typeof e[a],a));if(t.doesObjectExist(e[a]))continue;d(e[a],n,e,r)}},u=function(e,n,r){for(var o in e)if(c(e,o))if(e[o]instanceof Array)i(e[o],n||e,r);else if("object"==typeof e[o]){if(t.doesObjectExist(e[o]))continue;d(e[o],n||e,e,r)}},f=function(t,e){for(var n=null,r=0;t.changeset.length>r;r++)if(t.changeset[r].propertyName===""+e){n=t.changeset[r];break}null!==n?n.currentValue=t.current[e]:(t.changeset.push({propertyName:""+e,originalValue:t.original[e],currentValue:t.current[e],object:t.current}),t.getStatus()===ObjectContext.ObjectStatus.Unmodified&&t.setStatus(ObjectContext.ObjectStatus.Modified))},h=function(e){for(var n in e.current)if(c(e.current,n))if(e.current[n]instanceof Array){for(var r=e.current[n],o=0,a=0;r.length>a;a++)t.getObjectStatus(r[a])===ObjectContext.ObjectStatus.Deleted&&o++;e.current[n].length-o!==e.original[n].length&&f(e,n)}else"object"!=typeof e.current[n]&&e.current[n]!==e.original[n]&&f(e,n)},l=function(t){for(var n=0;e.length>n;n++)if(e[n].current===t)return n;return null},b=function(t){var n=l(t);if(null===n)throw Error("Object not found.");return e[n]},j=function(t,n){for(var r=[],o=0;e.length>o;o++){var a=e[o];a.getStatus()!==t||n&&(n!==!0||a.rootParent)||r.push(e[o].current)}return r},g=function(t){var e=/function (.{1,})\(/,n=e.exec(""+t.constructor);return n&&n.length>1?n[1]:""},d=function(n,r,a,c){if(!n)throw Error("Invalid object specified.");if("object"!=typeof n||n instanceof Array)throw Error('Invalid object specified. The value provided must be of type "object".');if(t.doesObjectExist(n))return t;if(n._objectMeta||(n._objectMeta={status:c?ObjectContext.ObjectStatus.New:ObjectContext.ObjectStatus.Unmodified,type:g(n)}),n._objectMeta.status||(n._objectMeta.status=ObjectContext.ObjectStatus.Unmodified),n._objectMeta.type||(n._objectMeta.type=g(n)),n._objectMeta&&n._objectMeta.status&&n._objectMeta.status===ObjectContext.ObjectStatus.New&&(c=!0),n._objectMeta.status!==ObjectContext.ObjectStatus.New&&n._objectMeta.status!==ObjectContext.ObjectStatus.Unmodified&&n._objectMeta.status!==ObjectContext.ObjectStatus.Modified&&n._objectMeta.status!==ObjectContext.ObjectStatus.Deleted)throw Error(o("Invalid object status: {0}",n._objectMeta.status));return c&&n._objectMeta.status!==ObjectContext.ObjectStatus.New&&(n._objectMeta.status=ObjectContext.ObjectStatus.New),e.push(s(n,r,a)),u(n,r,c),t};this.evaluate=function(){for(var t=0;e.length>t;t++){var r=e[t];r.getStatus()!==ObjectContext.ObjectStatus.Deleted&&(u(r.current,r.rootParent,!0),h(r))}for(var o=0;n.length>o;o++){var a=n[o];a&&"function"==typeof a&&a(this.hasChanges())}return this},this.doesObjectExist=function(t){if(!t)return!1;for(var n=0;e.length>n;n++)if(e[n].current===t)return!0;return!1},this.add=function(t,e){return d(t,null,null,e)},this.delete=function(t,n,r){var o=l(t);if(null===o)throw Error("Object was not found. Removal failed.");e[o].getStatus()===ObjectContext.ObjectStatus.New&&(n=!0),n===!0?(e[o].getStatus()===ObjectContext.ObjectStatus.New&&e[o].parent&&e[o].parent instanceof Array&&e[o].parent.splice(e[o].parent.indexOf(e[o].current),1),r?delete e[o].current._objectMeta:e[o].setStatus(e[o].getOriginalStatus()),e.splice(o,1)):e[o].getStatus()!==ObjectContext.ObjectStatus.New&&e[o].setStatus(ObjectContext.ObjectStatus.Deleted);for(var a=e.length-1;a>=0;a--){var s=e[a];s.current!==t&&s.rootParent===t&&(n===!0?e.splice(a,1):s.getStatus()!==ObjectContext.ObjectStatus.New&&s.setStatus(ObjectContext.ObjectStatus.Deleted))}return this.evaluate(),this},this.hasChanges=function(t){if(t){var n=b(t);return n.hasChanges()}for(var r=0;e.length>r;r++)if(e[r].hasChanges())return!0;return!1},this.hasChildChanges=function(t){if(!t)throw Error("Error determining if object has child changes. The object could not be found.");var e=b(t);return e.hasChanges(),e.hasChildChanges},this.clear=function(t){for(var n=0;e.length>n;n++)t?delete e[n].current._objectMeta:e[n].setStatus(e[n].getOriginalStatus());return e.length=0,this},this.getObjects=function(t){for(var n=[],r=0;e.length>r;r++)n.push(t?e[r]:e[r].current);return n},this.getUnmodifiedObjects=function(t){return j(ObjectContext.ObjectStatus.Unmodified,t)},this.getModifiedObjects=function(t){return j(ObjectContext.ObjectStatus.Modified,t)},this.getNewObjects=function(t){return j(ObjectContext.ObjectStatus.New,t)},this.getDeletedObjects=function(t){return j(ObjectContext.ObjectStatus.Deleted,t)},this.getObjectsByType=function(t){for(var n=[],r=0;e.length>r;r++)e[r].current._objectMeta.type===t&&n.push(e[r].current);return n},this.acceptChanges=function(){for(var t=!1,n=e.length-1;n>=0;n--){var o=e[n];o.getStatus()===ObjectContext.ObjectStatus.Deleted&&o.parent&&o.parent instanceof Array&&(o.parent.splice(o.parent.indexOf(o.current),1),e.splice(n,1),t=!0)}t&&this.evaluate();for(var n=e.length-1;n>=0;n--){var o=e[n];o.getStatus()!==ObjectContext.ObjectStatus.Unmodified&&(o.getStatus()===ObjectContext.ObjectStatus.Deleted?e.splice(n,1):(o.changeset=[],o.setStatus(ObjectContext.ObjectStatus.Unmodified),o.original=r(o.current)))}return this.evaluate(),this},this.getChangeset=function(t,n){var r=null;t&&(r=b(t));var o=r?r.changeset:[];if(!t||n&&!r.rootParent)for(var a=0;e.length>a;a++){var s=e[a];if(t){if(s===r)continue;s.rootParent===r.current&&s.changeset.length>0&&(o=o.concat(s.changeset))}else o=o.concat(s.changeset)}return o},this.getOriginal=function(t){for(var n=0;e.length>n;n++)if(e[n].current===t)return r(e[n].original);return null},this.getObjectStatus=function(t){if(!t)throw Error("Invalid object provided.");var n=l(t);if(null===n)throw Error(o("Invalid object index: {0}",n));return e[n].getStatus()},this.rejectChanges=function(n){if(n){var r=b(n);if(r.getStatus()===ObjectContext.ObjectStatus.New)for(var o=e.length-1;o>=0;o--){var a=e[o];(a===r||a.rootParent===r.current||a.parent===r.current)&&t.delete(a.current,!0)}else for(var o=0;e.length>o;o++){var a=e[o];a.rootParent&&a.getStatus()!==ObjectContext.ObjectStatus.Modified&&a.getStatus()!==ObjectContext.ObjectStatus.Deleted||O(a)}}else for(var o=e.length-1;o>=0;o--){var r=e[o];switch(r.getStatus()){case ObjectContext.ObjectStatus.Modified:case ObjectContext.ObjectStatus.Deleted:O(r);break;case ObjectContext.ObjectStatus.New:t.delete(r.current,!0)}}return this.evaluate(),this};var O=function(t){for(var n=0;t.changeset.length>n;n++){var r=t.changeset[n].propertyName;if(t.current[r]instanceof Array)for(var o=t.current[r],a=o.length-1;a>=0;a--){var s=b(o[a]);switch(s.getStatus()){case ObjectContext.ObjectStatus.Unmodified:continue;case ObjectContext.ObjectStatus.Modified:case ObjectContext.ObjectStatus.Deleted:O(s);break;case ObjectContext.ObjectStatus.New:o.splice(a,1),e.splice(e.indexOf(s),1)}}else t.current[r]=t.original[r]}t.setStatus(t.getOriginalStatus()),t.changeset=[],t.hasChildChanges=!1};this.subscribeChangeListener=function(t){if("function"!=typeof t)throw Error("The provided listener must be a function callback.");return n.push(t),n.length},this.unsubscribeChangeListener=function(t){if(0>n.indexOf(t))throw Error("The provided listener function was not subscribed.");return n.splice(n.indexOf(t),1),n.length},this.create=function(t,e){if(!t||"string"!=typeof t||0===(""+t).trim().length)throw Error("Invalid type provided.");if(!e)throw Error("Invalid object provided.");return e._objectMeta={type:t,status:ObjectContext.ObjectStatus.New},d(e,null,null,!0),this.evaluate(),this},this.query=function(t,n){function r(t){for(var e in n)if(!t.hasOwnProperty(e)||t[e]!==n[e])return!1;return!0}if("string"!=typeof t)throw Error("The provided type must be a string.");if(n&&"object"!=typeof n)throw Error("The provided query parameters must be an object.");for(var o=[],a=0;e.length>a;a++){var s=e[a];s.getType()===t&&(!n||r(s.current))&&o.push(s.current)}return o},this.log=function(){console.group("ObjectContext"),console.log("Has Changes: "+this.hasChanges()),console.log("Tracked Objects: "+e.length);for(var t=[],n=[],r=0;e.length>r;r++)e[r].rootParent?n.push(e[r]):t.push(e[r]);return console.group("All Objects"),console.dir(e),console.groupEnd("All Objects"),console.group("Parent Objects"),console.dir(t),console.groupEnd("Parent Objects"),console.group("Child Objects"),console.dir(n),console.groupEnd("Child Objects"),console.group("Objects by Status"),console.log("Unmodified",this.getUnmodifiedObjects()),console.log("Modified",this.getModifiedObjects()),console.log("New",this.getNewObjects()),console.log("Deleted",this.getDeletedObjects()),console.groupEnd("Objects by Status"),console.groupEnd("ObjectContext"),this}}ObjectContext.ObjectStatus={New:"New",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};