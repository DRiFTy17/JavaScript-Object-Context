ObjectContext.ObjectStatus={New:"New",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};function ObjectContext(){this._objectMap=[];this._changeListeners=[]}ObjectContext.prototype.subscribeChangeListener=function(a){if("function"!==typeof a)throw Error("The provided listener must be a function callback.");this._changeListeners.push(a)};
ObjectContext.prototype.unsubscribeChangeListener=function(a){if(0>this._changeListeners.indexOf(a))throw Error("The provided listener function was not subscribed.");this._changeListeners.splice(this._changeListeners.indexOf(a),1)};
ObjectContext.prototype.add=function(a,b,c,d){if("object"!==typeof a||a instanceof Array)throw Error('Invalid object specified. The value provided must be of type "object".');if(this.doesObjectExist(a))throw Error("Object already exists in the context.");a._objectMeta?a._objectMeta.status?a._objectMeta.type?a._objectMeta&&a._objectMeta.status&&a._objectMeta.status===ObjectContext.ObjectStatus.New&&(d=!0):a._objectMeta.type="Object":a._objectMeta.status=ObjectContext.ObjectStatus.Unmodified:a._objectMeta=
{status:d?ObjectContext.ObjectStatus.New:ObjectContext.ObjectStatus.Unmodified,type:"Object"};if(a._objectMeta.status!==ObjectContext.ObjectStatus.New&&a._objectMeta.status!==ObjectContext.ObjectStatus.Unmodified&&a._objectMeta.status!==ObjectContext.ObjectStatus.Modified&&a._objectMeta.status!==ObjectContext.ObjectStatus.Deleted)throw Error(this.stringFormat("Invalid object status: {0}",a._objectMeta.status));this._objectMap.push(this._createMappedObject(a,b,c));this._addChildren(a,b,d);return this};
ObjectContext.prototype._addChildren=function(a,b,c){for(var d in a)this._isTrackableProperty(a,d)&&(a[d]instanceof Array?this._addArray(a[d],b||a,c):"object"!==typeof a[d]||this.doesObjectExist(a[d])||this.add(a[d],b||a,a,c))};
ObjectContext.prototype._addArray=function(a,b,c){if(!(a instanceof Array))throw Error("An array must be specified.");for(var d=0;d<a.length;d++)if("function"!==typeof a[d])if(a[d]instanceof Array)this._addArray(a[d],b,c);else if("object"===typeof a[d])this.doesObjectExist(a[d])||this.add(a[d],b,a,c);else throw Error(this.stringFormat('Invalid array item type found ("{0}") at index {1}.',typeof a[d],d));};
ObjectContext.prototype._isTrackableProperty=function(a,b){return a.hasOwnProperty(b)&&"function"!==typeof a[b]&&"_"!==b.toString().substring(0,1)&&"$"!==b.toString().substring(0,1)?!0:!1};
ObjectContext.prototype._createMappedObject=function(a,b,c){var d=this;return{current:a,original:d._deepCopy(a),hasChanges:function(){var a=d._doesObjectHaveChanges(this);this.hasChildChanges=!1;for(var b=0;b<d._objectMap.length;b++){var c=d._objectMap[b];if(c!==this&&(c.rootParent===this.current||c.parent===this.current)&&d._doesObjectHaveChanges(c)){this.hasChildChanges=!0;break}}return a},changeset:[],rootParent:b,parent:c,hasChildChanges:!1}};
ObjectContext.prototype._doesObjectHaveChanges=function(a){if(!(a&&a.changeset&&a.current&&a.current._objectMeta&&a.current._objectMeta.status))throw Error("Invalid object provided");return 0<a.changeset.length||a.current._objectMeta.status===ObjectContext.ObjectStatus.New||a.current._objectMeta.status===ObjectContext.ObjectStatus.Modified||a.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted};
ObjectContext.prototype.doesObjectExist=function(a){if(!a)return!1;for(var b=0;b<this._objectMap.length;b++)if(this._objectMap[b].current===a)return!0;return!1};
ObjectContext.prototype.deleteObject=function(a,b){var c=this._getMapIndex(a);if(null===c)throw Error("Object was not found. Removal failed.");this._objectMap[c].current._objectMeta.status===ObjectContext.ObjectStatus.New&&(b=!0);!0===b?(this._objectMap[c].current._objectMeta.status===ObjectContext.ObjectStatus.New&&this._objectMap[c].parent&&this._objectMap[c].parent instanceof Array&&this._objectMap[c].parent.splice(this._objectMap[c].parent.indexOf(this._objectMap[c].current),1),this._objectMap.splice(c,
1)):this._objectMap[c].current._objectMeta.status!==ObjectContext.ObjectStatus.New&&(this._objectMap[c].current._objectMeta.status=ObjectContext.ObjectStatus.Deleted);for(c=this._objectMap.length-1;0<=c;c--){var d=this._objectMap[c];d.current!==a&&d.rootParent===a&&(!0===b?this._objectMap.splice(c,1):d.current._objectMeta.status!==ObjectContext.ObjectStatus.New&&(d.current._objectMeta.status=ObjectContext.ObjectStatus.Deleted))}this.evaluate();return this};
ObjectContext.prototype._getMapIndex=function(a){for(var b=0;b<this._objectMap.length;b++)if(this._objectMap[b].current===a)return b;return null};ObjectContext.prototype.getOriginal=function(a){for(var b=0;b<this._objectMap.length;b++)if(this._objectMap[b].current===a)return this._deepCopy(this._objectMap[b].original);return null};ObjectContext.prototype._getMappedObject=function(a){a=this._getMapIndex(a);if(null===a)throw Error(this.stringFormat("Invalid object index: {0}",a));return this._objectMap[a]};
ObjectContext.prototype.getObjectStatus=function(a){if(!a)throw Error("Invalid object provided.");a=this._getMapIndex(a);if(null===a)throw Error(this.stringFormat("Invalid object index: {0}",a));return this._objectMap[a].current._objectMeta.status};
ObjectContext.prototype.evaluate=function(){for(var a=0;a<this._objectMap.length;a++){var b=this._objectMap[a];b.current._objectMeta.status!==ObjectContext.ObjectStatus.Deleted&&(this._addChildren(b.current,b.rootParent,!0),this._checkForChanges(b))}for(a=0;a<this._changeListeners.length;a++)(b=this._changeListeners[a])&&"function"===typeof b&&b(this.hasChanges());return this};
ObjectContext.prototype._checkForChanges=function(a){for(var b in a.current)if(this._isTrackableProperty(a.current,b))if(a.current[b]instanceof Array){if(!(a.original[b]instanceof Array))throw Error('Property type ("Array") has been modified from the original type.');a.current[b].length!==a.original[b].length&&this._setPropertyChanged(a,b)}else"object"!==typeof a.current[b]&&a.current[b]!==a.original[b]&&this._setPropertyChanged(a,b)};
ObjectContext.prototype._setPropertyChanged=function(a,b){for(var c=null,d=0;d<a.changeset.length;d++)if(a.changeset[d].propertyName===b.toString()){c=a.changeset[d];break}null!==c?c.currentValue=a.current[b]:(a.changeset.push({propertyName:b.toString(),originalValue:a.original[b],currentValue:a.current[b],object:a.current}),a.current._objectMeta.status===ObjectContext.ObjectStatus.Unmodified&&(a.current._objectMeta.status=ObjectContext.ObjectStatus.Modified))};
ObjectContext.prototype.rejectChanges=function(a){if(a){a=this._getMapIndex(a);if(null===a)throw Error("Could not determine object index. Reject changes failed.");this._resetObject(this._objectMap[a])}else for(a=0;a<this._objectMap.length;a++)this._resetObject(this._objectMap[a]);this.evaluate();return this};
ObjectContext.prototype._resetObject=function(a){if(!a)throw Error("Invalid object provided.");for(var b=0;b<a.changeset.length;b++){var c=a.changeset[b].propertyName;if(a.current[c]instanceof Array)for(var d=a.current[c].length-1;0<=d;d--)a.current[c][d]._objectMeta.status===ObjectContext.ObjectStatus.New&&a.current[c].splice(d,1);else a.current[c]=a.original[c]}a.current._objectMeta.status=a.original._objectMeta.status;a.changeset=[];a.hasChildChanges=!1;if(!a.rootParent)for(b=this._objectMap.length-
1;0<=b;b--)c=this._objectMap[b],c!==a&&c.current._objectMeta.status!==ObjectContext.ObjectStatus.New&&(c.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted?c.current._objectMeta.status=c.original._objectMeta.status:c.rootParent===a.current&&this._resetObject(c))};ObjectContext.prototype.hasChanges=function(){for(var a=0;a<this._objectMap.length;a++)if(this._objectMap[a].hasChanges())return!0;return!1};
ObjectContext.prototype.hasChildChanges=function(a){if(!a)throw Error("Error determing if object has child changes. The object could not be found.");a=this._getMappedObject(a);if(!a)throw Error("Invalid object provided.");return a.hasChildChanges};ObjectContext.prototype.clear=function(){this._objectMap=[];this._changeListeners=[];return this};
ObjectContext.prototype.getChangeset=function(a,b){var c=null;if(a&&(c=this._getMappedObject(a),!c))throw Error("The object could not be found.");var d=c?c.changeset:[];if(!a||b&&!c.rootParent)for(var e=0;e<this._objectMap.length;e++){var f=this._objectMap[e];a?f!==c&&f.rootParent===c.current&&0<f.changeset.length&&(d=d.concat(f.changeset)):d=d.concat(f.changeset)}return d};
ObjectContext.prototype.getObjects=function(a){for(var b=[],c=0;c<this._objectMap.length;c++)b.push(a?this._objectMap[c]:this._objectMap[c].current);return b};ObjectContext.prototype.getUnmodifiedObjects=function(a){return this._getObjectsByStatus(ObjectContext.ObjectStatus.Unmodified,a)};ObjectContext.prototype.getModifiedObjects=function(a){return this._getObjectsByStatus(ObjectContext.ObjectStatus.Modified,a)};
ObjectContext.prototype.getNewObjects=function(a){return this._getObjectsByStatus(ObjectContext.ObjectStatus.New,a)};ObjectContext.prototype.getDeletedObjects=function(a){return this._getObjectsByStatus(ObjectContext.ObjectStatus.Deleted,a)};
ObjectContext.prototype._getObjectsByStatus=function(a,b){if(!a||a!==ObjectContext.ObjectStatus.New&&a!==ObjectContext.ObjectStatus.Modified&&a!==ObjectContext.ObjectStatus.Unmodified&&a!==ObjectContext.ObjectStatus.Deleted)throw Error(this.stringFormat('Invalid status ("{0}"). Status must be either "Unmodified", "Modified", "New", or "Deleted".',a));for(var c=[],d=0;d<this._objectMap.length;d++){var e=this._objectMap[d];e.current._objectMeta.status!==a||b&&(!0!==b||e.rootParent)||c.push(this._objectMap[d].current)}return c};
ObjectContext.prototype.getObjectsByType=function(a){for(var b=[],c=0;c<this._objectMap.length;c++)this._objectMap[c].current._objectMeta.type===a&&b.push(this._objectMap[c].current);return b};
ObjectContext.prototype.acceptChanges=function(){for(var a=!1,b=this._objectMap.length-1;0<=b;b--){var c=this._objectMap[b];c.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted&&c.parent&&c.parent instanceof Array&&(c.parent.splice(c.parent.indexOf(c.current),1),this._objectMap.splice(b,1),a=!0)}a&&this.evaluate();for(b=this._objectMap.length-1;0<=b;b--)c=this._objectMap[b],c.current._objectMeta.status!==ObjectContext.ObjectStatus.Unmodified&&(c.current._objectMeta.status===ObjectContext.ObjectStatus.Deleted?
this._objectMap.splice(b,1):(c.changeset=[],c.current._objectMeta.status=ObjectContext.ObjectStatus.Unmodified,c.original=this._deepCopy(c.current)));this.evaluate();return this};
ObjectContext.prototype.log=function(){console.group("ObjectContext");console.log("Has Changes: "+this.hasChanges());console.log("Tracked Objects: "+this._objectMap.length);for(var a=[],b=[],c=0;c<this._objectMap.length;c++)this._objectMap[c].rootParent?b.push(this._objectMap[c]):a.push(this._objectMap[c]);console.group("All Objects");console.dir(this._objectMap);console.groupEnd("All Objects");console.group("Parent Objects");console.dir(a);console.groupEnd("Parent Objects");console.group("Child Objects");
console.dir(b);console.groupEnd("Child Objects");console.group("Objects by Status");console.log("Unmodified",this.getUnmodifiedObjects());console.log("Modified",this.getModifiedObjects());console.log("New",this.getNewObjects());console.log("Deleted",this.getDeletedObjects());console.groupEnd("Objects by Status");console.groupEnd("ObjectContext")};
ObjectContext.prototype.stringFormat=function(){for(var a=arguments[0],b=0;b<arguments.length-1;b++)a=a.replace(new RegExp("\\{"+b+"\\}","gm"),arguments[b+1]);return a};ObjectContext.prototype._deepCopy=function(a){return JSON.parse(JSON.stringify(a))};