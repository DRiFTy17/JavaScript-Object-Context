(function(){function f(a){return e.prototype.stringFormat("{0}: {1}","ObjectContextException",a)}function e(a,b,c,d,e){var f=this;this.ObjectStatus={New:"New",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};this.isSubmitting=this.isLoading=!1;this._endpointUri=e;this._rootScope=a;this._q=b;this._http=c;this._objectMap=[];this._changeListeners=[];this._autoEvaluate=!!d;this._offDigestWatch=null;this._autoEvaluate&&(this._offDigestWatch=this._rootScope.$watch(function(){f._autoEvaluate&&
0<f._objectMap.length&&f.evaluate()}))}angular.module("ngObjectContext",[]).provider("objectContext",function(){var a=!0,b=null,c=null;this.restrictToSingleContext=function(b){a=b};this.setEndpointUri=function(a){c=a.trim()};this.$get=["$rootScope","$q","$http",function(d,f,g){return{create:function(h){h="undefined"!==typeof h?!!h:!0;return a?b=b||new e(d,f,g,h,c):new e(d,f,g,h,c)},getInstance:function(a){return b||this.create("undefined"!==typeof a?!!a:!0)}}}]});e.prototype.subscribeChangeListener=
function(a){if("function"!==typeof a)throw f("The provided listener must be a function callback.");this._changeListeners.push(a)};e.prototype.unsubscribeChangeListener=function(a){if(0>this._changeListeners.indexOf(a))throw f("The provided listener function was not subscribed.");this._changeListeners.splice(this._changeListeners.indexOf(a),1)};e.prototype.add=function(a,b,c,d){if("object"!==typeof a||a instanceof Array)throw f('Invalid object specified. The value provided must be of type "object".');
if(this._doesObjectExist(a))throw f("Object already exists in the context.");a._objectMeta?a._objectMeta.status?a._objectMeta.type?a._objectMeta&&a._objectMeta.status&&a._objectMeta.status===this.ObjectStatus.New&&(d=!0):a._objectMeta.type="Object":a._objectMeta.status=this.ObjectStatus.Unmodified:a._objectMeta={status:d?this.ObjectStatus.New:this.ObjectStatus.Unmodified,type:"Object"};if(a._objectMeta.status!==this.ObjectStatus.New&&a._objectMeta.status!==this.ObjectStatus.Unmodified&&a._objectMeta.status!==
this.ObjectStatus.Modified&&a._objectMeta.status!==this.ObjectStatus.Deleted)throw f(this.stringFormat("Invalid object status: {0}",a._objectMeta.status));this._objectMap.push(this._createMappedObject(a,b,c));this._addChildren(a,b,d)};e.prototype._addChildren=function(a,b,c){for(var d in a)this._isTrackableProperty(a,d)&&(a[d]instanceof Array?this._addArray(a[d],b||a,c):"object"!==typeof a[d]||this._doesObjectExist(a[d])||this.add(a[d],b||a,a,c))};e.prototype._addArray=function(a,b,c){if(!(a instanceof
Array))throw f("An array must be specified.");for(var d=0;d<a.length;d++)if("function"!==typeof a[d])if(a[d]instanceof Array)this._addArray(a[d],b,c);else if("object"===typeof a[d])this._doesObjectExist(a[d])||this.add(a[d],b,a,c);else throw f(this.stringFormat('Invalid array item type found ("{0}") at index {1}.',typeof a[d],d));};e.prototype._isTrackableProperty=function(a,b){return a.hasOwnProperty(b)&&"function"!==typeof a[b]&&"_"!==b.toString().substring(0,1)&&"$"!==b.toString().substring(0,
1)?!0:!1};e.prototype._createMappedObject=function(a,b,c){var d=this;return{current:a,original:angular.copy(a),hasChanges:function(){return 0<this.changeset.length||this.current._objectMeta.status===d.ObjectStatus.New||this.current._objectMeta.status===d.ObjectStatus.Modified||this.current._objectMeta.status===d.ObjectStatus.Deleted},changeset:[],rootParent:b,parent:c}};e.prototype._doesObjectExist=function(a){for(var b=0;b<this._objectMap.length;b++)if(this._objectMap[b].current===a)return!0;return!1};
e.prototype.deleteObject=function(a,b){var c=this._getMapIndex(a);if(null===c)throw f("Object was not found. Removal failed.");this._objectMap[c].current._objectMeta.status===this.ObjectStatus.New&&(b=!0);!0===b?this._objectMap.splice(c,1):this._objectMap[c].current._objectMeta.status!==this.ObjectStatus.New&&(this._objectMap[c].current._objectMeta.status=this.ObjectStatus.Deleted);for(c=this._objectMap.length-1;0<=c;c--){var d=this._objectMap[c];d.current!==a&&d.rootParent===a&&(!0===b?this._objectMap.splice(c,
1):d.current._objectMeta.status!==this.ObjectStatus.New&&(d.current._objectMeta.status=this.ObjectStatus.Deleted))}this.evaluate()};e.prototype.removeAll=function(a){if(!0===a)this._objectMap=[];else for(a=0;a<this._objectMap.length;a++)this._objectMap[a].current._objectMeta.status=this.ObjectStatus.Deleted;this.evaluate()};e.prototype._getMapIndex=function(a){for(var b=0;b<this._objectMap.length;b++)if(this._objectMap[b].current===a)return b;return null};e.prototype.getOriginal=function(a){for(var b=
0;b<this._objectMap.length;b++)if(this._objectMap[b].current===a)return angular.copy(obj.original);return null};e.prototype._getMappedObject=function(a){a=this._getMapIndex(a);if(null===a)throw f(this.stringFormat("Invalid object index: {0}",a));return this._objectMap[a]};e.prototype.getObjectStatus=function(a){if(!a)throw f("Invalid object provided.");a=this._getMapIndex(a);if(null===a)throw f(this.stringFormat("Invalid object index: {0}",a));return this._objectMap[a].current._objectMeta.status};
e.prototype.evaluate=function(){for(var a=0;a<this._objectMap.length;a++){var b=this._objectMap[a];b.current._objectMeta.status!==this.ObjectStatus.Deleted&&(this._addChildren(b.current,b.rootParent,!0),this._checkForChanges(b))}for(a=0;a<this._changeListeners.length;a++)(b=this._changeListeners[a])&&"function"===typeof b&&b(this.hasChanges())};e.prototype._checkForChanges=function(a){for(var b in a.current)if(this._isTrackableProperty(a.current,b))if(a.current[b]instanceof Array){if(!(a.original[b]instanceof
Array))throw f('Property type ("Array") has been modified from the original type.');a.current[b].length!==a.original[b].length&&this._setPropertyChanged(a,b)}else"object"!==typeof a.current[b]&&a.current[b]!==a.original[b]&&this._setPropertyChanged(a,b)};e.prototype._setPropertyChanged=function(a,b){for(var c=null,d=0;d<a.changeset.length;d++)if(a.changeset[d].propertyName===b.toString()){c=a.changeset[d];break}null!==c?c.currentValue=a.current[b]:(a.changeset.push({propertyName:b.toString(),originalValue:a.original[b],
currentValue:a.current[b],object:a.current}),a.current._objectMeta.status===this.ObjectStatus.Unmodified&&(a.current._objectMeta.status=this.ObjectStatus.Modified))};e.prototype.revert=function(a){if(!a)throw f("Invalid object provided.");a=this._getMapIndex(a);if(null===a)throw f("Could not determine object index. Revert changes failed.");this._resetObject(this._objectMap[a]);this.evaluate()};e.prototype.revertAll=function(){for(var a=0;a<this._objectMap.length;a++)this._resetObject(this._objectMap[a]);
this.evaluate()};e.prototype._resetObject=function(a){if(!a)throw f("Invalid object provided.");for(var b=0;b<a.changeset.length;b++){var c=a.changeset[b].propertyName;if(a.current[c]instanceof Array)for(var d=a.current[c].length-1;0<=d;d--)a.current[c][d]._objectMeta.status===this.ObjectStatus.New&&a.current[c].splice(d,1);else a.current[c]=a.original[c]}a.current._objectMeta.status=a.original._objectMeta.status;a.changeset=[];if(!a.rootParent)for(b=this._objectMap.length-1;0<=b;b--)c=this._objectMap[b],
c!==a&&c.current._objectMeta.status!==this.ObjectStatus.New&&(c.current._objectMeta.status===this.ObjectStatus.Deleted?c.current._objectMeta.status=c.original._objectMeta.status:c.rootParent===a.current&&this._resetObject(c))};e.prototype.hasChanges=function(){for(var a=0;a<this._objectMap.length;a++)if(this._objectMap[a].hasChanges())return!0;return!1};e.prototype.clear=function(){this._objectMap=[];this._changeListeners=[]};e.prototype.getChangeset=function(a,b){var c=null;if(a&&(c=this._getMappedObject(a),
!c))throw f("The object could not be found.");var d=c?c.changeset:[];if(!a||b&&!c.rootParent)for(var e=0;e<this._objectMap.length;e++){var g=this._objectMap[e];a?g!==c&&g.rootParent===c.current&&0<g.changeset.length&&(d=d.concat(g.changeset)):d=d.concat(g.changeset)}return d};e.prototype.setAutoEvaluate=function(a){var b=this;(this._autoEvaluate=!!a)&&null===this._offDigestWatch?this._offDigestWatch=this._rootScope.$watch(function(){b._autoEvaluate&&0<b._objectMap.length&&b.evaluate()}):!this._autoEvaluate&&
this._offDigestWatch&&(this._offDigestWatch(),this._offDigestWatch=null)};e.prototype.get=function(a,b){if(!a||0===a.toString().trim().length)throw f("Invalid type specified.");if(!this._endpointUri)throw f("No endpoint URI specified.");var c=this._q.defer();this.isLoading=!0;this._endpointUri.slice(-1);var d=new Person((new Date).getTime(),"Brad",51);d._objectMeta.status=this.ObjectStatus.New;this.add(d);this.isLoading=!1;c.resolve(d);this.evaluate();return c.promise};e.prototype.saveChanges=function(){var a=
this._q.defer();this.isSubmitting=!0;for(var b=this._objectMap.length-1;0<=b;b--){var c=this._objectMap[b];c.current._objectMeta.status===this.ObjectStatus.Deleted?this._objectMap.splice(b,1):(c.changeset=[],c.current._objectMeta.status=this.ObjectStatus.Unmodified,c.original=angular.copy(c.current))}this.evaluate();this.isSubmitting=!1;a.resolve();return a.promise};e.prototype.getObjects=function(){for(var a=[],b=0;b<this._objectMap.length;b++)a.push(this._objectMap[b].current);return a};e.prototype.getUnmodifiedObjects=
function(a){return this._getObjectsByStatus(this.ObjectStatus.Unmodified,a)};e.prototype.getModifiedObjects=function(a){return this._getObjectsByStatus(this.ObjectStatus.Modified,a)};e.prototype.getNewObjects=function(a){return this._getObjectsByStatus(this.ObjectStatus.New,a)};e.prototype.getDeletedObjects=function(a){return this._getObjectsByStatus(this.ObjectStatus.Deleted,a)};e.prototype._getObjectsByStatus=function(a,b){if(!a||a!==this.ObjectStatus.New&&a!==this.ObjectStatus.Modified&&a!==this.ObjectStatus.Unmodified&&
a!==this.ObjectStatus.Deleted)throw f(this.stringFormat('Invalid status ("{0}"). Status must be either "Unmodified", "Modified", "New", or "Deleted".',a));for(var c=[],d=0;d<this._objectMap.length;d++){var e=this._objectMap[d];e.current._objectMeta.status!==a||b&&(!0!==b||e.rootParent)||c.push(this._objectMap[d].current)}return c};e.prototype.getObjectsByType=function(a){for(var b=[],c=0;c<this._objectMap.length;c++)this._objectMap[c].current._objectMeta.type===a&&b.push(this._objectMap[c].current);
return b};e.prototype.applyChanges=function(){for(var a=this._objectMap.length-1;0<=a;a--){var b=this._objectMap[a];b.current._objectMeta.status===this.ObjectStatus.Deleted?this._objectMap.splice(a,1):b.current._objectMeta.status!==this.ObjectStatus.Unmodified&&(b.changeset=[],b.current._objectMeta.status=this.ObjectStatus.Unmodified,b.original=angular.copy(b.current))}this.evaluate()};e.prototype.log=function(){console.group("ObjectContext");console.log("Has Changes: "+this.hasChanges());console.log("Tracked Objects: "+
this._objectMap.length);for(var a=[],b=0;b<this._objectMap.length;b++)this._objectMap[b].rootParent||a.push(this._objectMap[b]);console.group("Parent Objects");console.dir(a);console.groupEnd();console.group("All Objects");console.dir(this._objectMap);console.groupEnd();console.group("Changed Objects");console.log("Unmodified",this.getUnmodifiedObjects());console.log("Modified",this.getModifiedObjects());console.log("New",this.getNewObjects());console.log("Deleted",this.getDeletedObjects());console.groupEnd();
console.groupEnd()};e.prototype.stringFormat=function(){for(var a=arguments[0],b=0;b<arguments.length-1;b++)a=a.replace(new RegExp("\\{"+b+"\\}","gm"),arguments[b+1]);return a}})();