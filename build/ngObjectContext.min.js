angular.module("ngObjectContext",[]).provider("objectContext",function(){var f=!0,d=null;this.allowMultipleInstances=function(d){f=!d};this.$get=["$rootScope",function(k){var h=[];return{create:function(l){l="undefined"!==typeof l?!!l:!0;if(f)d||(d=new ObjectContext,l&&h.push({contextInstance:d,deregisterWatchFn:k.$watch(function(){d.evaluate()})}));else{var g=new ObjectContext;l&&h.push({contextInstance:g,deregisterWatchFn:k.$watch(function(){d.evaluate()})});return g}return d},getInstance:function(l){return d||
this.create("undefined"!==typeof l?!!l:!0)},stopAutoWatch:function(d){for(var g=h.length-1;0<=g;g--)h[g].contextInstance===d&&h[g].deregisterWatchFn&&(h[g].deregisterWatchFn(),h.splice(g,1))},startAutoWatch:function(d){if(!d)throw Error("Invalid context instance specified.");for(var g=!1,f=0;f<h.length;f++)h[f].contextInstance===d&&(g=!0);!g&&d.evaluate&&h.push({contextInstance:d,deregisterWatchFn:k.$watch(function(){d.evaluate()})})}}}]});"use strict";
ObjectContext.ObjectStatus={New:"New",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};
function ObjectContext(){var f=this,d=[],k=[],h=function(){for(var a=arguments[0],b=0;b<arguments.length-1;b++)a=a.replace(new RegExp("\\{"+b+"\\}","gm"),arguments[b+1]);return a},l=function(a){return 0<a.changeset.length||a.getStatus()===ObjectContext.ObjectStatus.New||a.getStatus()===ObjectContext.ObjectStatus.Modified||a.getStatus()===ObjectContext.ObjectStatus.Deleted},g=function(a,b,c){return{current:a,original:JSON.parse(JSON.stringify(a)),hasChanges:function(){var a=l(this);this.hasChildChanges=
!1;for(var b=0;b<d.length;b++){var c=d[b];if(c!==this&&(c.rootParent===this.current||c.parent===this.current)&&l(c)){this.hasChildChanges=!0;break}}return a},changeset:[],rootParent:b,parent:c,hasChildChanges:!1,getStatus:function(){return this.current._objectMeta.status},setStatus:function(a){this.current._objectMeta.status=a},getOriginalStatus:function(){return this.original._objectMeta.status}}},s=function(a,b){return a.hasOwnProperty(b)&&"function"!==typeof a[b]&&"_"!==b.toString().substring(0,
1)&&"$"!==b.toString().substring(0,1)?!0:!1},t=function(a,b,c){if(!(a instanceof Array))throw Error("An array must be specified.");for(var d=0;d<a.length;d++)if("function"!==typeof a[d])if(a[d]instanceof Array)t(a[d],b,c);else if("object"===typeof a[d])f.doesObjectExist(a[d])||p(a[d],b,a,c);else throw Error(h('Invalid array item type found ("{0}") at index {1}.',typeof a[d],d));},u=function(a,b,c){for(var d in a)s(a,d)&&(a[d]instanceof Array?t(a[d],b||a,c):"object"!==typeof a[d]||f.doesObjectExist(a[d])||
p(a[d],b||a,a,c))},v=function(a,b){for(var c=null,d=0;d<a.changeset.length;d++)if(a.changeset[d].propertyName===b.toString()){c=a.changeset[d];break}null!==c?c.currentValue=a.current[b]:(a.changeset.push({propertyName:b.toString(),originalValue:a.original[b],currentValue:a.current[b],object:a.current}),a.getStatus()===ObjectContext.ObjectStatus.Unmodified&&a.setStatus(ObjectContext.ObjectStatus.Modified))},q=function(a){for(var b=0;b<d.length;b++)if(d[b].current===a)return b;return null},m=function(a){a=
q(a);if(null===a)throw Error("Invalid object index.");return d[a]},n=function(a,b){for(var c=[],e=0;e<d.length;e++){var f=d[e];f.getStatus()!==a||b&&(!0!==b||f.rootParent)||c.push(d[e].current)}return c},p=function(a,b,c,e){if(!a)throw Error("Invalid object specified.");if("object"!==typeof a||a instanceof Array)throw Error('Invalid object specified. The value provided must be of type "object".');if(f.doesObjectExist(a))throw Error("Object already exists in the context.");a._objectMeta?a._objectMeta.status?
a._objectMeta.type?a._objectMeta&&a._objectMeta.status&&a._objectMeta.status===ObjectContext.ObjectStatus.New&&(e=!0):a._objectMeta.type="Object":a._objectMeta.status=ObjectContext.ObjectStatus.Unmodified:a._objectMeta={status:e?ObjectContext.ObjectStatus.New:ObjectContext.ObjectStatus.Unmodified,type:"Object"};if(a._objectMeta.status!==ObjectContext.ObjectStatus.New&&a._objectMeta.status!==ObjectContext.ObjectStatus.Unmodified&&a._objectMeta.status!==ObjectContext.ObjectStatus.Modified&&a._objectMeta.status!==
ObjectContext.ObjectStatus.Deleted)throw Error(h("Invalid object status: {0}",a._objectMeta.status));e&&a._objectMeta.status!==ObjectContext.ObjectStatus.New&&(a._objectMeta.status=ObjectContext.ObjectStatus.New);d.push(g(a,b,c));u(a,b,e);return f};this.evaluate=function(){for(var a=0;a<d.length;a++){var b=d[a];if(b.getStatus()!==ObjectContext.ObjectStatus.Deleted){u(b.current,b.rootParent,!0);var c=void 0;for(c in b.current)if(s(b.current,c))if(b.current[c]instanceof Array){for(var e=b.current[c],
h=0,g=0;g<e.length;g++)f.getObjectStatus(e[g])===ObjectContext.ObjectStatus.Deleted&&h++;b.current[c].length-h!==b.original[c].length&&v(b,c)}else"object"!==typeof b.current[c]&&b.current[c]!==b.original[c]&&v(b,c)}}for(a=0;a<k.length;a++)(b=k[a])&&"function"===typeof b&&b(this.hasChanges());return this};this.doesObjectExist=function(a){if(!a)return!1;for(var b=0;b<d.length;b++)if(d[b].current===a)return!0;return!1};this.add=function(a,b){return p(a,null,null,b)};this.deleteObject=function(a,b){var c=
q(a);if(null===c)throw Error("Object was not found. Removal failed.");d[c].getStatus()===ObjectContext.ObjectStatus.New&&(b=!0);!0===b?(d[c].getStatus()===ObjectContext.ObjectStatus.New&&d[c].parent&&d[c].parent instanceof Array&&d[c].parent.splice(d[c].parent.indexOf(d[c].current),1),d.splice(c,1)):d[c].getStatus()!==ObjectContext.ObjectStatus.New&&d[c].setStatus(ObjectContext.ObjectStatus.Deleted);for(c=d.length-1;0<=c;c--){var e=d[c];e.current!==a&&e.rootParent===a&&(!0===b?d.splice(c,1):e.getStatus()!==
ObjectContext.ObjectStatus.New&&e.setStatus(ObjectContext.ObjectStatus.Deleted))}this.evaluate();return this};this.hasChanges=function(a){if(a){a=m(a);if(!a)throw Error("Invalid object provided.");return a.hasChanges()}for(a=0;a<d.length;a++)if(d[a].hasChanges())return!0;return!1};this.hasChildChanges=function(a){if(!a)throw Error("Error determining if object has child changes. The object could not be found.");a=m(a);if(!a)throw Error("Invalid object provided.");a.hasChanges();return a.hasChildChanges};
this.clear=function(){d=[];return this};this.getObjects=function(a){for(var b=[],c=0;c<d.length;c++)b.push(a?d[c]:d[c].current);return b};this.getUnmodifiedObjects=function(a){return n(ObjectContext.ObjectStatus.Unmodified,a)};this.getModifiedObjects=function(a){return n(ObjectContext.ObjectStatus.Modified,a)};this.getNewObjects=function(a){return n(ObjectContext.ObjectStatus.New,a)};this.getDeletedObjects=function(a){return n(ObjectContext.ObjectStatus.Deleted,a)};this.getObjectsByType=function(a){for(var b=
[],c=0;c<d.length;c++)d[c].current._objectMeta.type===a&&b.push(d[c].current);return b};this.acceptChanges=function(){for(var a=!1,b=d.length-1;0<=b;b--){var c=d[b];c.getStatus()===ObjectContext.ObjectStatus.Deleted&&c.parent&&c.parent instanceof Array&&(c.parent.splice(c.parent.indexOf(c.current),1),d.splice(b,1),a=!0)}a&&this.evaluate();for(b=d.length-1;0<=b;b--)c=d[b],c.getStatus()!==ObjectContext.ObjectStatus.Unmodified&&(c.getStatus()===ObjectContext.ObjectStatus.Deleted?d.splice(b,1):(c.changeset=
[],c.setStatus(ObjectContext.ObjectStatus.Unmodified),c.original=JSON.parse(JSON.stringify(c.current))));this.evaluate();return this};this.getChangeset=function(a,b){var c=null;if(a&&(c=m(a),!c))throw Error("The object could not be found.");var e=c?c.changeset:[];if(!a||b&&!c.rootParent)for(var g=0;g<d.length;g++){var f=d[g];a?f!==c&&f.rootParent===c.current&&0<f.changeset.length&&(e=e.concat(f.changeset)):e=e.concat(f.changeset)}return e};this.getOriginal=function(a){for(var b=0;b<d.length;b++)if(d[b].current===
a)return JSON.parse(JSON.stringify(d[b].original));return null};this.getObjectStatus=function(a){if(!a)throw Error("Invalid object provided.");a=q(a);if(null===a)throw Error(h("Invalid object index: {0}",a));return d[a].getStatus()};this.rejectChanges=function(a){if(a){a=m(a);if(null===a)throw Error("Could not determine object index. Reject changes failed.");if(a.getStatus()===ObjectContext.ObjectStatus.New)for(var b=d.length-1;0<=b;b--){var c=d[b];c!==a&&c.rootParent!==a.current&&c.parent!==a.current||
f.deleteObject(c.current,!0)}else for(b=0;b<d.length;b++)c=d[b],c.rootParent&&c.getStatus()!==ObjectContext.ObjectStatus.Modified&&c.getStatus()!==ObjectContext.ObjectStatus.Deleted||r(c)}else for(b=d.length-1;0<=b;b--)switch(a=d[b],a.getStatus()){case ObjectContext.ObjectStatus.Modified:case ObjectContext.ObjectStatus.Deleted:r(a);break;case ObjectContext.ObjectStatus.New:f.deleteObject(a.current,!0)}this.evaluate();return this};var r=function(a){for(var b=0;b<a.changeset.length;b++){var c=a.changeset[b].propertyName;
if(a.current[c]instanceof Array)for(var c=a.current[c],e=c.length-1;0<=e;e--){var f=m(c[e]);switch(f.getStatus()){case ObjectContext.ObjectStatus.Unmodified:continue;case ObjectContext.ObjectStatus.Modified:case ObjectContext.ObjectStatus.Deleted:r(f);break;case ObjectContext.ObjectStatus.New:c.splice(e,1),d.splice(d.indexOf(f),1)}}else a.current[c]=a.original[c]}a.setStatus(a.getOriginalStatus());a.changeset=[];a.hasChildChanges=!1};this.subscribeChangeListener=function(a){if("function"!==typeof a)throw Error("The provided listener must be a function callback.");
k.push(a);return k.length};this.unsubscribeChangeListener=function(a){if(0>k.indexOf(a))throw Error("The provided listener function was not subscribed.");k.splice(k.indexOf(a),1);return k.length};this.log=function(){console.group("ObjectContext");console.log("Has Changes: "+this.hasChanges());console.log("Tracked Objects: "+d.length);for(var a=[],b=[],c=0;c<d.length;c++)d[c].rootParent?b.push(d[c]):a.push(d[c]);console.group("All Objects");console.dir(d);console.groupEnd("All Objects");console.group("Parent Objects");
console.dir(a);console.groupEnd("Parent Objects");console.group("Child Objects");console.dir(b);console.groupEnd("Child Objects");console.group("Objects by Status");console.log("Unmodified",this.getUnmodifiedObjects());console.log("Modified",this.getModifiedObjects());console.log("New",this.getNewObjects());console.log("Deleted",this.getDeletedObjects());console.groupEnd("Objects by Status");console.groupEnd("ObjectContext");return this}};