"use strict";function ObjectContext(){var t=this,e=[],n=[],r=function(t){return JSON.parse(JSON.stringify(t))},o=function(){for(var t=arguments[0],e=0;arguments.length-1>e;e++){var n=RegExp("\\{"+e+"\\}","gm");t=t.replace(n,arguments[e+1])}return t},s=function(t){return t.changeset.length>0||t.status===ObjectContext.ObjectStatus.New||t.status===ObjectContext.ObjectStatus.Modified||t.status===ObjectContext.ObjectStatus.Deleted},a=function(t,n,o,a,c){return{current:t,original:r(t),hasChanges:function(){var t=s(this);this.hasChildChanges=!1;for(var n=0;e.length>n;n++){var r=e[n];if(r!==this&&(r.rootParent===this.current||r.parent===this.current)&&s(r)){this.hasChildChanges=!0;break}}return t},changeset:[],rootParent:a,parent:c,hasChildChanges:!1,status:n,originalStatus:n,type:o,key:t.ExtensionData&&t.ExtensionData.Key&&t.ExtensionData.Key.length?t.ExtensionData.Key:null}},c=function(t,e){return t.hasOwnProperty(e)&&"function"!=typeof t[e]&&"_"!==(""+e).substring(0,1)&&"$"!==(""+e).substring(0,1)?!0:!1},i=function(e,n,r){if(!(e instanceof Array))throw Error("An array must be specified.");for(var s=0;e.length>s;s++)if("function"!=typeof e[s])if(e[s]instanceof Array)i(e[s],n,r);else{if("object"!=typeof e[s])throw Error(o('Invalid array item type found ("{0}") at index {1}.',typeof e[s],s));if(t.doesObjectExist(e[s]))continue;g(e[s],n,e,r)}},u=function(e,n,r){for(var o in e)if(c(e,o))if(e[o]instanceof Array)i(e[o],n||e,r);else if("object"==typeof e[o]){if(t.doesObjectExist(e[o]))continue;g(e[o],n||e,e,r)}},h=function(t,e){for(var n=null,r=0;t.changeset.length>r;r++)if(t.changeset[r].propertyName===""+e){n=t.changeset[r];break}null!==n?n.oldValue!=t.current[e]?n.newValue=t.current[e]:t.changeset.splice(t.changeset.indexOf(n),1):(t.changeset.push({propertyName:""+e,oldValue:t.original[e],newValue:t.current[e]}),t.status===ObjectContext.ObjectStatus.Unmodified&&(t.status=ObjectContext.ObjectStatus.Modified))},f=function(e){for(var n in e.current)if(c(e.current,n))if(e.current[n]instanceof Array)for(var r=e.current[n],o=0,s=0;r.length>s;s++)t.getObjectStatus(r[s])===ObjectContext.ObjectStatus.Deleted&&o++;else"object"!=typeof e.current[n]&&e.current[n]!==e.original[n]&&h(e,n)},l=function(t){for(var n=0;e.length>n;n++)if(e[n].current===t)return n;return null},b=function(t){var n=l(t);if(null===n)throw Error("Object not found.");return e[n]},d=function(t,n){for(var r=[],o=0;e.length>o;o++){var s=e[o];s.status!==t||n&&(n!==!0||s.rootParent)||r.push(e[o].current)}return r},j=function(t){var e=/function (.{1,})\(/,n=e.exec(""+t.constructor);return n&&n.length>1?n[1]:""},g=function(n,r,o,s){var c=s?ObjectContext.ObjectStatus.New:ObjectContext.ObjectStatus.Unmodified,i=j(n);if(!n||"object"!=typeof n||n instanceof Array)throw Error('Invalid object specified. The value provided must be of type "object".');return t.doesObjectExist(n)?t:(e.push(a(n,c,i,r,o)),u(n,r,s),t)};this.evaluate=function(){for(var t=0;e.length>t;t++){var r=e[t];r.status!==ObjectContext.ObjectStatus.Deleted&&(u(r.current,r.rootParent,!0),f(r))}for(var o=0;n.length>o;o++){var s=n[o];s&&"function"==typeof s&&s(this.hasChanges())}return this},this.doesObjectExist=function(t){if(!t)return!1;for(var n=0;e.length>n;n++)if(e[n].current===t)return!0;return!1},this.add=function(t,e){return g(t,null,null,e)},this.delete=function(t,n){var r=l(t);if(null===r)throw Error("Object was not found. Removal failed.");e[r].status===ObjectContext.ObjectStatus.New&&(n=!0),n===!0?(e[r].status===ObjectContext.ObjectStatus.New&&e[r].parent&&e[r].parent instanceof Array&&e[r].parent.splice(e[r].parent.indexOf(e[r].current),1),e.splice(r,1)):e[r].status!==ObjectContext.ObjectStatus.New&&(e[r].status=ObjectContext.ObjectStatus.Deleted);for(var o=e.length-1;o>=0;o--){var s=e[o];s.current!==t&&s.rootParent===t&&(n===!0?e.splice(o,1):s.status!==ObjectContext.ObjectStatus.New&&(s.status=ObjectContext.ObjectStatus.Deleted))}return this.evaluate(),this},this.hasChanges=function(t){if(t){var n=b(t);return n.hasChanges()}for(var r=0;e.length>r;r++)if(e[r].hasChanges())return!0;return!1},this.hasChildChanges=function(t){if(!t)throw Error("Error determining if object has child changes. The object could not be found.");var e=b(t);return e.hasChanges(),e.hasChildChanges},this.clear=function(){return e.length=0,this},this.getObjects=function(t){for(var n=[],r=0;e.length>r;r++)n.push(t?e[r]:e[r].current);return n},this.getUnmodifiedObjects=function(t){return d(ObjectContext.ObjectStatus.Unmodified,t)},this.getModifiedObjects=function(t){return d(ObjectContext.ObjectStatus.Modified,t)},this.getNewObjects=function(t){return d(ObjectContext.ObjectStatus.New,t)},this.getDeletedObjects=function(t){return d(ObjectContext.ObjectStatus.Deleted,t)},this.getObjectsByType=function(t){for(var n=[],r=0;e.length>r;r++)e[r].type===t&&n.push(e[r].current);return n},this.acceptChanges=function(){for(var t=!1,n=e.length-1;n>=0;n--){var o=e[n];o.status===ObjectContext.ObjectStatus.Deleted&&o.parent&&o.parent instanceof Array&&(o.parent.splice(o.parent.indexOf(o.current),1),e.splice(n,1),t=!0)}t&&this.evaluate();for(var n=e.length-1;n>=0;n--){var o=e[n];o.status!==ObjectContext.ObjectStatus.Unmodified&&(o.status===ObjectContext.ObjectStatus.Deleted?e.splice(n,1):(o.changeset=[],o.status=ObjectContext.ObjectStatus.Unmodified,o.original=r(o.current)))}return this.evaluate(),this},this.getObjectChangeset=function(t){if(!t)throw Error("Invalid object provided. You must provided an object.");var e=null;if(e=b(t),!e)throw Error("Invalid object provided. Changeset could not be found.");return e.changeset},this.getChangeset=function(){var t={};t[ObjectContext.ObjectStatus.New]=[],t[ObjectContext.ObjectStatus.Modified]=[],t[ObjectContext.ObjectStatus.Deleted]=[];for(var n=0;e.length>n;n++){var o=e[n];o.status!==ObjectContext.ObjectStatus.Unmodified&&t[o.status].push({type:o.type,changeset:o.changeset,object:r(o.current)})}return t},this.getOriginal=function(t){for(var n=0;e.length>n;n++)if(e[n].current===t)return r(e[n].original);return null},this.getObjectStatus=function(t){if(!t)throw Error("Invalid object provided.");var n=l(t);if(null===n)throw Error(o("Invalid object index: {0}",n));return e[n].status},this.getObjectType=function(t){if(!t)throw Error("Invalid object provided.");var n=l(t);if(null===n)throw Error(o("Invalid object index: {0}",n));return e[n].type},this.rejectChanges=function(n){if(n){var r=b(n);if(r.status===ObjectContext.ObjectStatus.New)for(var o=e.length-1;o>=0;o--){var s=e[o];(s===r||s.rootParent===r.current||s.parent===r.current)&&t.delete(s.current,!0)}else for(var o=0;e.length>o;o++){var s=e[o];s.rootParent&&s.status!==ObjectContext.ObjectStatus.Modified&&s.status!==ObjectContext.ObjectStatus.Deleted?s.status===ObjectContext.ObjectStatus.New&&t.delete(s.current,!0):O(s)}}else for(var o=e.length-1;o>=0;o--){var r=e[o];switch(r.status){case ObjectContext.ObjectStatus.Modified:case ObjectContext.ObjectStatus.Deleted:O(r);break;case ObjectContext.ObjectStatus.New:t.delete(r.current,!0)}}return this.evaluate(),this};var O=function(t){for(var n=0;t.changeset.length>n;n++){var r=t.changeset[n].propertyName;if(t.current[r]instanceof Array)for(var o=t.current[r],s=o.length-1;s>=0;s--){var a=b(o[s]);switch(a.status){case ObjectContext.ObjectStatus.Unmodified:continue;case ObjectContext.ObjectStatus.Modified:case ObjectContext.ObjectStatus.Deleted:O(a);break;case ObjectContext.ObjectStatus.New:o.splice(s,1),e.splice(e.indexOf(a),1)}}else t.current[r]=t.original[r]}t.status=t.originalStatus,t.changeset=[],t.hasChildChanges=!1};this.subscribeChangeListener=function(t){if("function"!=typeof t)throw Error("The provided listener must be a function callback.");return n.push(t),n.length},this.unsubscribeChangeListener=function(t){if(0>n.indexOf(t))throw Error("The provided listener function was not subscribed.");return n.splice(n.indexOf(t),1),n.length},this.query=function(t,n){function r(t){for(var e in n)if(!t.hasOwnProperty(e)||t[e]!==n[e])return!1;return!0}if("string"!=typeof t)throw Error("The provided type must be a string.");if(n&&"object"!=typeof n)throw Error("The provided query parameters must be an object.");for(var o=[],s=0;e.length>s;s++){var a=e[s];a.type===t&&(!n||r(a.current))&&o.push(a.current)}return o},this.log=function(){var t=new Date,n=t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()+":"+t.getMilliseconds();console.group("ObjectContext: "+n),console.log("Has Changes: "+this.hasChanges()),console.log("Tracked Objects: "+e.length);for(var r=[],o=[],s=0;e.length>s;s++)e[s].rootParent?o.push(e[s]):r.push(e[s]);return console.group("All Objects"),console.dir(e),console.groupEnd("All Objects"),console.group("Parent Objects"),console.dir(r),console.groupEnd("Parent Objects"),console.group("Child Objects"),console.dir(o),console.groupEnd("Child Objects"),console.group("Objects by Status"),console.log("Unmodified",this.getUnmodifiedObjects()),console.log("Modified",this.getModifiedObjects()),console.log("New",this.getNewObjects()),console.log("Deleted",this.getDeletedObjects()),console.groupEnd("Objects by Status"),console.groupEnd("ObjectContext"),this}}ObjectContext.ObjectStatus={New:"New",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};