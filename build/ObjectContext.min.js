(function(){"use strict";function e(){var t=this;var n=[];var r=[];var i=null;var s=[];var o=null;var u=null;var a=0;var f=function(e){return JSON.parse(JSON.stringify(e))};var l=function(){var e=arguments[0];for(var t=0;t<arguments.length-1;t++){var n=new RegExp("\\{"+t+"\\}","gm");e=e.replace(n,arguments[t+1])}return e};var c=function(t){return t.changeset.length>0||t.status===e.ObjectStatus.Added||t.status===e.ObjectStatus.Modified||t.status===e.ObjectStatus.Deleted};var h=function(){a=0;for(var e=0;e<n.length;e++){n.identifier=++a}};var p=function(e,t,r,i,s){return{current:e,original:f(e),hasChanges:function(){var e=c(this);this.hasChildChanges=false;for(var t=0;t<n.length;t++){var r=n[t];if(r===this)continue;if(r.rootParent===this.current||r.parent===this.current){if(c(r)){this.hasChildChanges=true;break}}}return e},changeset:[],rootParent:i,parent:s,hasChildChanges:false,status:t,originalStatus:t,type:r,key:u&&u.trim().length>0&&e.hasOwnProperty(u)?e[u]:null,identifier:++a}};var d=function(e,t){if(!e.hasOwnProperty(t)||typeof e[t]==="function"||t.toString().substring(0,1)==="_"||t.toString().substring(0,1)==="$"||s.indexOf(t)>=0){return false}return true};var v=function(e){var t=Object.keys(e).length;if(t===0)return false;var n=0;for(var r in e){if(!d(e,r)){n++}}return t!==n};var m=function(e){for(var t=0;t<n.length;t++){if(n[t].identifier==e){return n[t]}}return null};var g=function(e,t){for(var n in t){if(t.hasOwnProperty(n)&&d(t,n)&&e.current.hasOwnProperty(n)&&e.original.hasOwnProperty(n)&&typeof e.current[n]!=="object"&&!(e.current[n]instanceof Array)&&e.current[n]!==t[n]){e.current[n]=t[n];e.original[n]=t[n]}}};var y=function(e,n,r){if(!(e instanceof Array)){throw new Error("An array must be specified.")}for(var i=0;i<e.length;i++){if(typeof e[i]==="function"){continue}if(e[i]instanceof Array){y(e[i],n,r)}else if(e[i]&&typeof e[i]==="object"){if(t.doesObjectExist(e[i])){continue}C(e[i],n,e,r)}}};var b=function(e,n,r){for(var i in e){if(!d(e,i)){continue}if(e[i]instanceof Array){y(e[i],n||e,r)}else if(e[i]&&typeof e[i]==="object"){if(t.doesObjectExist(e[i])){continue}C(e[i],n||e,e,r)}}};var w=function(t,n){var r=null;for(var i=0;i<t.changeset.length;i++){if(t.changeset[i].PropertyName===n.toString()){r=t.changeset[i];break}}if(r!==null){if(r.OldValue!=t.current[n]){r.NewValue=t.current[n]}else{t.changeset.splice(t.changeset.indexOf(r),1)}}else{t.changeset.push({PropertyName:n.toString(),OldValue:t.original[n],NewValue:t.current[n]});if(t.status===e.ObjectStatus.Unmodified){t.status=e.ObjectStatus.Modified}}};var E=function(n){for(var r in n.current){if(!d(n.current,r)){continue}if(n.current[r]instanceof Array){var i=n.current[r];var s=0;for(var o=0;o<i.length;o++){if(typeof i[o]==="object"&&v(i[o])){if(t.getObjectStatus(i[o])===e.ObjectStatus.Deleted){s++}}}if(n.current[r].length-s!==n.original[r].length){w(n,r)}else if(n.current[r].length===n.original[r].length){for(var o=0;o<n.current[r].length;o++){var u=n.current[r][o];if(typeof u!=="object"){var a=n.original[r][o];if(u!==a){w(n,r);break}}}}}else if((n.current[r]===null||typeof n.current[r]!=="object")&&n.current[r]!==n.original[r]){w(n,r)}}};var S=function(e){for(var t=0;t<n.length;t++){if(n[t].current===e){return t}}return null};var x=function(e){var t=S(e);if(t===null){throw new Error("Object not found.")}return n[t]};var T=function(e,t){var r=[];for(var i=0;i<n.length;i++){var s=n[i];if(s.status===e&&(!t||t===true&&!s.rootParent)){r.push(n[i].current)}}return r};var N=function(e){var t=/function (.{1,})\(/;var n=t.exec(e.constructor.toString());return n&&n.length>1?n[1]:""};var C=function(r,i,s,u){if(!r||typeof r!=="object"||r instanceof Array){throw new Error('Invalid object specified. The value provided must be of type "object".')}var a=u?e.ObjectStatus.Added:e.ObjectStatus.Unmodified;var f=o&&o.trim().length>0&&r.hasOwnProperty(o)?r[o]:N(r);if(t.doesObjectExist(r)||!v(r)){return t}n.push(p(r,a,f,i,s));b(r,i,u);return t};this.setServiceUri=function(e){i=e;return this};this.setObjectTypePropertyName=function(e){o=e;return this};this.setObjectKeyPropertyName=function(e){u=e;return this};this.evaluate=function(){for(var t=0;t<n.length;t++){var i=n[t];if(i.status===e.ObjectStatus.Deleted){continue}b(i.current,i.rootParent,true);E(i)}for(var s=0;s<r.length;s++){var o=r[s];if(o&&typeof o==="function"){o(this.hasChanges())}}return this};this.doesObjectExist=function(e){if(!e)return false;for(var t=0;t<n.length;t++){if(n[t].current===e){return true}}return false};this.add=function(e,t){return C(e,null,null,t)};this.delete=function(t,r){var i=S(t);if(i===null){throw new Error("Object was not found. Removal failed.")}if(n[i].status===e.ObjectStatus.Added){r=true}if(r===true){if(n[i].status===e.ObjectStatus.Added&&n[i].parent&&n[i].parent instanceof Array){n[i].parent.splice(n[i].parent.indexOf(n[i].current),1)}n.splice(i,1)}else if(n[i].status!==e.ObjectStatus.Added){n[i].status=e.ObjectStatus.Deleted}for(var s=n.length-1;s>=0;s--){var o=n[s];if(o.current===t){continue}if(o.rootParent===t){if(r===true){n.splice(s,1)}else if(o.status!==e.ObjectStatus.Added){o.status=e.ObjectStatus.Deleted}}}this.evaluate();return this};this.hasChanges=function(e){if(e){var t=x(e);return t.hasChanges()}else{for(var r=0;r<n.length;r++){if(n[r].hasChanges()){return true}}}return false};this.hasChildChanges=function(e){if(!e){throw new Error("Error determining if object has child changes. The object could not be found.")}var t=x(e);t.hasChanges();return t.hasChildChanges};this.clear=function(){n.length=0;return this};this.getObjects=function(e){var t=[];for(var r=0;r<n.length;r++){t.push(e?n[r]:n[r].current)}return t};this.getUnmodifiedObjects=function(t){return T(e.ObjectStatus.Unmodified,t)};this.getModifiedObjects=function(t){return T(e.ObjectStatus.Modified,t)};this.getAddedObjects=function(t){return T(e.ObjectStatus.Added,t)};this.getDeletedObjects=function(t){return T(e.ObjectStatus.Deleted,t)};this.getObjectsByType=function(e){var t=[];for(var r=0;r<n.length;r++){if(n[r].type===e){t.push(n[r].current)}}return t};this.acceptChanges=function(t){var r=false;for(var i=n.length-1;i>=0;i--){var s=n[i];if(s.status===e.ObjectStatus.Deleted&&s.parent&&s.parent instanceof Array){s.parent.splice(s.parent.indexOf(s.current),1);n.splice(i,1);r=true}}if(r)this.evaluate();for(var i=n.length-1;i>=0;i--){var s=n[i];if(s.status!==e.ObjectStatus.Unmodified){if(s.status===e.ObjectStatus.Deleted){n.splice(i,1)}else{s.changeset=[];s.status=e.ObjectStatus.Unmodified;s.originalStatus=s.status;s.original=f(s.current)}}}if(t&&typeof t==="object"){for(var o in t){if(t.hasOwnProperty(o)&&t[o]&&typeof t[o]==="object"){var u=m(o);if(!u)continue;g(u,t[o])}}}this.evaluate();return this};this.getObjectChangeset=function(e){if(!e){throw new Error("Invalid object provided. You must provided an object.")}var t=x(e);return t.changeset};this.getChangeset=function(){var t={};t[e.ObjectStatus.Added]=[];t[e.ObjectStatus.Modified]=[];t[e.ObjectStatus.Deleted]=[];for(var r=0;r<n.length;r++){var i=n[r];if(i.status===e.ObjectStatus.Unmodified)continue;var s={};s["Changeset"]=i.changeset;s["Object"]=f(i.current);s["ContextIdentifier"]=i.identifier;t[i.status].push(s)}return t};this.getOriginal=function(e){for(var t=0;t<n.length;t++){if(n[t].current===e){return f(n[t].original)}}return null};this.getObjectStatus=function(e){if(!e){throw new Error("Invalid object provided.")}var t=S(e);if(t===null){throw new Error(l("Invalid object index: {0}",t))}return n[t].status};this.getObjectType=function(e){if(!e){throw new Error("Invalid object provided.")}var t=S(e);if(t===null){throw new Error(l("Invalid object index: {0}",t))}return n[t].type};this.rejectChanges=function(r){if(r){var i=x(r);if(i.status===e.ObjectStatus.Added){for(var s=n.length-1;s>=0;s--){var o=n[s];if(o===i||o.rootParent===i.current||o.parent===i.current){t.delete(o.current,true)}}}else{for(var s=0;s<n.length;s++){var o=n[s];if(!o.rootParent||o.status===e.ObjectStatus.Modified||o.status===e.ObjectStatus.Deleted){k(o)}else if(o.status===e.ObjectStatus.Added){t.delete(o.current,true)}}}}else{for(var s=n.length-1;s>=0;s--){var i=n[s];switch(i.status){case e.ObjectStatus.Modified:case e.ObjectStatus.Deleted:k(i);break;case e.ObjectStatus.Added:t.delete(i.current,true);break}}}this.evaluate();return this};var k=function(t){for(var r=0;r<t.changeset.length;r++){var i=t.changeset[r].PropertyName;if(t.current[i]instanceof Array){var s=t.current[i];for(var o=s.length-1;o>=0;o--){if(typeof s[o]==="object"){var u=x(s[o]);switch(u.status){case e.ObjectStatus.Unmodified:continue;break;case e.ObjectStatus.Modified:case e.ObjectStatus.Deleted:k(u);break;case e.ObjectStatus.Added:s.splice(o,1);n.splice(n.indexOf(u),1);break}}else{t.current[i]=f(t.original[i])}}}else{t.current[i]=t.original[i]}}t.status=t.originalStatus;t.changeset=[];t.hasChildChanges=false};this.subscribeChangeListener=function(e){if(typeof e!=="function"){throw new Error("The provided listener must be a function callback.")}r.push(e);return r.length};this.unsubscribeChangeListener=function(e){if(r.indexOf(e)<0){throw new Error("The provided listener function was not subscribed.")}r.splice(r.indexOf(e),1);return r.length};this.query=function(e,t){function o(e){for(var n in t){if(!e.hasOwnProperty(n)||e[n]!==t[n]){return false}}return true}if(typeof e!=="string"){throw new Error("The provided type must be a string.")}else if(t&&typeof t!=="object"){throw new Error("The provided query parameters must be an object.")}var r=[];for(var i=0;i<n.length;i++){var s=n[i];if(s.type===e){if(!t||o(s.current)){r.push(s.current)}}}return r};this.load=function(e,t,n,r){var s=this;if(!window.XMLHttpRequest){throw new Error("Browser does not support XMLHttpRequest.")}else if(!e||typeof e!=="string"||e.trim().length===0){throw new Error("Invalid load action provided: "+e)}else if(t!=="GET"&&t!=="POST"){throw new Error("Invalid request method provided: "+t+". Only GET and POST requests are supported.")}else if(!r||typeof r!=="function"){throw new Error("Invalid callback provided. You must provide a callback function for when the request completes.")}var o=i?i+e:e;var u=null;if(n){if(t==="POST"){u=JSON.stringify(n)}else if(t==="GET"){var a=[];for(var f in n){if(n.hasOwnProperty(f)){a.push(encodeURIComponent(f)+"="+encodeURIComponent(n[f]))}}o+="?"+a.join("&")}}var l=new XMLHttpRequest;l.open(t,o,true);l.setRequestHeader("Accept","application/json");l.setRequestHeader("Content-Type","application/json");var c=function(){l.abort();r({isSuccessful:false,data:null,errorMessage:"ObjectContext: Request timed out."})};var h=setTimeout(c,3e4);l.onreadystatechange=function(){if(l.readyState===4){if(l.status===200){clearTimeout(h);try{var e=JSON.parse(l.responseText);if(!e||typeof e!=="object"){r({isSuccessful:false,data:null,errorMessage:"Load Error: "+l.responseText});return}if(e instanceof Array){for(var t=0;t<e.length;t++){var n=e[t];if(typeof n==="object"){s.add(n)}}}else{if(typeof e==="object"){s.add(e)}}r({isSuccessful:true,data:e,errorMessage:null})}catch(i){r({isSuccessful:false,data:null,errorMessage:"Load Error: "+i.message})}}else{r({isSuccessful:false,data:null,errorMessage:"Load Error: "+l.status})}}};l.send(u)};this.addIgnoredProperties=function(e){if(!e||typeof e!=="object"||!(e instanceof Array)||e.length===0){throw new Error("Invalid array of properties to ignore was provided. Must be an array of strings.")}for(var t=0;t<e.length;t++){if(typeof e[t]==="string"){s.push(e[t])}else{throw new Error("addIgnoredProperties: Invalid property name. Ignored property name must be a string.")}}return this};this.addIgnoredProperty=function(e){if(!e||typeof e!=="string"||e.length===0){throw new Error("addIgnoredProperty: Invalid property name. Ignored property name must be a string.")}s.push(e);return this};this.log=function(){var e=new Date;var t=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+":"+e.getMilliseconds();console.group("ObjectContext: "+t);console.log("Has Changes: "+this.hasChanges());console.log("Tracked Objects: "+n.length);var r=[];var i=[];for(var s=0;s<n.length;s++){if(!n[s].rootParent){r.push(n[s])}else{i.push(n[s])}}console.group("All Objects");console.dir(n);console.groupEnd("All Objects");console.group("Parent Objects");console.dir(r);console.groupEnd("Parent Objects");console.group("Child Objects");console.dir(i);console.groupEnd("Child Objects");console.group("Objects by Status");console.log("Unmodified",this.getUnmodifiedObjects());console.log("Modified",this.getModifiedObjects());console.log("Added",this.getAddedObjects());console.log("Deleted",this.getDeletedObjects());console.groupEnd("Objects by Status");console.groupEnd("ObjectContext");return this}}e.ObjectStatus={Added:"Added",Unmodified:"Unmodified",Modified:"Modified",Deleted:"Deleted"};if(!window.ObjectContext){window.ObjectContext=e}})()